I"£g<blockquote>
  <p>â€œYeah Itâ€™s on. â€</p>
</blockquote>

<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>

<p>ç”±äºå…¬å¸æ–°ä¸šåŠ¡éœ€è¦ç”¨å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å®ç°æ’å…¥#æ ‡ç­¾ ã€@XX ã€$è‚¡ç¥¨ã€Linkã€ä»¥åŠå›¾ç‰‡åŠŸèƒ½ï¼Œå°±ç ”ç©¶äº†ä¸€ä¸‹æ–¹æ¡ˆã€‚</p>
<ol>
  <li>è°ƒç ”äº†å››ç§æ–¹æ¡ˆï¼Œåˆ†åˆ«æ˜¯TextView,CoreText,TableView,H5å®ç°åšåŠŸèƒ½æ¡¥æ¥ã€‚</li>
  <li>ç”±äºä¸šåŠ¡ä¸Šå®‰å“å…ˆè¡Œï¼Œé€‰å‹æ˜¯åŸç”Ÿå®ç°æ‰€ä»¥æŠ›å¼ƒäº†æ¡¥æ¥H5æ–¹æ¡ˆã€‚</li>
  <li>å®‰å“ä¸ºäº†çœäº‹æ‰¾äº†ä¸€ä¸ªç¬¬ä¸‰æ–¹å»å®ç°ï¼Œå°±æ˜¯åŸç”Ÿæ’å…¥ç¼–è¾‘ï¼Œå¦‚æœç”¨tableViewå®ç°ï¼ŒUIçœ‹èµ·æ¥å°±ä¸¤ç«¯ä¸åŒäº†æ‰€ä»¥ä¹Ÿæš‚æ—¶æŠ›å¼ƒã€‚</li>
  <li>æ€è€ƒäº†ä¸€ä¸‹TextViewåŠCoreTextçš„ä¼˜ç¼ºç‚¹ï¼ŒTextViewå®ç°æ•ˆç‡ä¸Šä¼šæ¯”CoreTextä½ï¼Œå‡ºé—®é¢˜çš„æ¦‚ç‡æ›´é«˜ï¼Œå®ç°æ—¶é—´çŸ­ï¼ŒCoreTextå®ç°æ•ˆç‡é«˜ï¼Œæ›´åå‘åº•å±‚ä¸Šä¸‹æ–‡ç»˜åˆ¶ï¼Œå› ä¸ºcoreTextä¸­å¤§é‡çš„è°ƒç”¨cçš„æ–¹æ³•ï¼Œå¦‚æœæ–°äººæ¥æ‰‹ä¸šåŠ¡æˆæœ¬é«˜ã€‚</li>
  <li>æ‰€ä»¥æš‚æ—¶é€‰æ‹©ä½¿ç”¨UITextViewé€ ä¸ªè½®å­ï¼Œä¸ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„åŸå› æ˜¯æ€•æœ‰å‘åˆ°æ—¶å€™æèµ·æ¥éº»çƒ¦ã€‚åé¢æœ‰æ—¶é—´ä¼šç”¨CoreTextå†æä¸€ä¸ªå‡ºæ¥ã€‚</li>
</ol>

<p id="build"></p>
<hr />

<h2 id="æ­£æ–‡">æ­£æ–‡</h2>

<h3 id="ç¬¬ä¸€æ­¥-æä¸€ä¸ªä¸‡èƒ½çš„model">ç¬¬ä¸€æ­¥: æä¸€ä¸ªä¸‡èƒ½çš„model</h3>
<p>ä¸ºä»€ä¹ˆè¦æè¿™ä¸ªmodel?ç¨‹åºå‘˜éƒ½æ‡’å§ï¼ŒæŠŠæ‰€æœ‰æ’å…¥çš„æ ‡ç­¾éœ€æ±‚æ•°æ®å­˜è¿›å»ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">objcMembers</span>
<span class="kd">class</span> <span class="nx">ReleaseContentDataModel</span><span class="p">:</span> <span class="nx">NSObject</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">location</span><span class="p">:</span> <span class="nx">Int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">var</span> <span class="nx">length</span><span class="p">:</span> <span class="nx">Int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="dl">""</span>
    <span class="kd">var</span> <span class="nx">json</span><span class="p">:</span> <span class="p">[</span><span class="nb">String</span> <span class="p">:</span> <span class="nx">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
    <span class="kd">var</span> <span class="nx">string</span> <span class="o">=</span> <span class="dl">""</span>
    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">""</span>
    <span class="kd">var</span> <span class="nx">renderingString</span> <span class="o">=</span> <span class="dl">""</span>
    <span class="kd">var</span> <span class="nx">id</span><span class="p">:</span> <span class="nx">Int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="dl">""</span>
    <span class="kd">var</span> <span class="nx">image</span><span class="p">:</span> <span class="nx">UIImage</span> <span class="o">=</span> <span class="nx">UIImage</span><span class="p">()</span>
    <span class="kd">var</span> <span class="nx">imageBounds</span><span class="p">:</span> <span class="nx">CGSize</span> <span class="o">=</span> <span class="nx">CGSize</span><span class="p">.</span><span class="nx">zero</span>
<span class="p">}</span>
</code></pre></div></div>
<p>ä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šä¹±ä¸ƒå…«ç³Ÿç±»å‹å’Œæ•°æ®ï¼Œéƒ½æ˜¯æ³ªï¼Œä¸šåŠ¡ä¸Šä¸æ–­è°ƒæ•´éœ€æ±‚å¯¼è‡´modelè¶Šæ¥è¶Šå£®äº†â€¦.ä¸è¿‡ç°åœ¨åº”è¯¥æ˜¯ä¸ªåŸºæœ¬çš„å®Œå…¨ä½“äº†ã€‚
è¿™ä¸ªmodelçš„ä¸»è¦åŠŸèƒ½æ˜¯ï¼š
1ã€ç»™æ¯ä¸ªéœ€è¦å’Œå‘å¸ƒé¡µé¢äº¤äº’çš„vcæä¾›æ¥å£
2ã€ç»™è‡ªå·±çš„åè§£ææä¾›æ•°æ®ç»“æ„ï¼Œé¿å…å“ªé‡Œéƒ½æœ‰ä¹±ä¸ƒå…«ç³Ÿã€‚åè§£æçš„éœ€æ±‚æ˜¯é€šè¿‡æœåŠ¡å™¨å­—ç¬¦ä¸²è§£ææˆæˆ‘ä»¬éœ€è¦çš„ç»“æ„ï¼Œç„¶åç»˜åˆ¶æˆUI,è€Œä¸Šé¢çš„modelå¹¶æ²¡æœ‰å’ŒæœåŠ¡å™¨äº¤äº’ï¼Œä½¿æˆ‘ä»¬æœ¬åœ°ç”Ÿæˆçš„ï¼Œæ‰€ä»¥åœ¨å¼€å‘æ—¶å€™è¦é¢„ç•™å¤„ç†æ–¹æ³•ã€‚
3ã€æœ€é‡è¦çš„å°±æ˜¯ç»™è‡ªå·±çš„UIæä¾›æ•°æ®è¿›è¡Œè§£æ</p>

<h3 id="ç¬¬äºŒæ­¥-å°è£…textview">ç¬¬äºŒæ­¥: å°è£…TextView</h3>
<p>æˆ‘çš„TextViewæ˜¯ç»§æ‰¿RSKPlaceholderTextViewçš„ï¼Œä¸»è¦æ˜¯å› ä¸ºæ‡’ï¼ŒPlaceholderæ ·å¼ä»€ä¹ˆçš„æ‡’å¾—å¤„ç†ç›´æ¥æä¸ªç¬¬ä¸‰æ–¹å¤„ç†æ‰ã€‚
ç»™å°è£…çš„TextViewæä¾›ä¸€ä¸ªå‚æ•°modelArrayï¼Œç”¨æ¥å­˜å‚¨ç»˜åˆ¶çš„æ‰€æœ‰æ ‡ç­¾å†…å®¹</p>

<h3 id="ç¬¬ä¸‰æ­¥-æä¾›æ’å…¥ç»˜åˆ¶æ¥å£">ç¬¬ä¸‰æ­¥: æä¾›æ’å…¥ç»˜åˆ¶æ¥å£</h3>
<p>ç°æœ‰æœ‰å››ç§æ ‡ç­¾å’Œå›¾ç‰‡æ ·å¼ï¼Œç”±äºå›¾ç‰‡çš„å¤„ç†å’Œæ ‡ç­¾æ‹¼æ¥æ–‡å­—æ–¹å¼ä¸åŒï¼Œæ‰€ä»¥å•ç‹¬æ‹‰å‡ºæ¥ä¸€ä¸ªæ–¹æ³•ã€‚</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">func</span> <span class="nx">setContentText</span><span class="p">(</span><span class="nx">model</span><span class="p">:</span> <span class="nx">ReleaseContentDataModel</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//0.åˆ¤æ–­æ˜¯å¦ä¸ºæ’å…¥ï¼Œå¦‚æœä¸ºæ’å…¥ï¼Œåé¢çš„tagéœ€è¦åŒæ—¶location å¢åŠ ä¸ºlocation+length</span>
        <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">modelArray</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">fullModel</span><span class="p">.</span><span class="nx">location</span> <span class="o">&lt;=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">location</span> <span class="p">{</span>
                <span class="nx">item</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">location</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> </span><span class="se">\</span><span class="s2">(model.string) </span><span class="dl">"</span><span class="p">.</span><span class="nx">length</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">//1.æ·»åŠ æ•°ç»„</span>
        <span class="kd">let</span> <span class="nx">itemModel</span> <span class="o">=</span> <span class="nx">ReleaseContentDataModel</span><span class="p">()</span>
        <span class="nx">itemModel</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">fullModel</span><span class="p">.</span><span class="nx">location</span>
        <span class="nx">itemModel</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="dl">"</span><span class="s2"> </span><span class="se">\</span><span class="s2">(model.string)</span><span class="dl">"</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">itemModel</span><span class="p">.</span><span class="nx">string</span> <span class="o">=</span> <span class="dl">"</span><span class="s2"> </span><span class="se">\</span><span class="s2">(model.string) </span><span class="dl">"</span>
        <span class="nx">itemModel</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">type</span>
        <span class="nx">itemModel</span><span class="p">.</span><span class="nx">code</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">code</span>
        <span class="nx">itemModel</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">id</span>
        <span class="nx">itemModel</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">url</span>
        <span class="nx">modelArray</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">itemModel</span><span class="p">)</span>

        <span class="c1">//2.æ•°æ®æºå†…tagæ•°ç»„æ·»åŠ å…ƒç´ </span>
        <span class="nx">fullModel</span><span class="p">.</span><span class="nx">range</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">NSRange</span><span class="p">(</span><span class="nx">location</span><span class="p">:</span> <span class="nx">fullModel</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span> <span class="nx">length</span><span class="p">:</span>  <span class="dl">"</span><span class="s2"> </span><span class="se">\</span><span class="s2">(model.string) </span><span class="dl">"</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span>
        <span class="c1">//3.å–å‡ºlocationä¸¤è¾¹çš„å­—ç¬¦ä¸²è¿›è¡Œæ‹¼æ¥</span>
        <span class="kd">let</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">NSMutableParagraphStyle</span><span class="p">()</span>
        <span class="nx">style</span><span class="p">.</span><span class="nx">lineBreakMode</span> <span class="o">=</span> <span class="p">.</span><span class="nx">byCharWrapping</span>
        
        <span class="kd">let</span> <span class="nx">tagString</span><span class="p">:</span> <span class="nx">NSMutableAttributedString</span> <span class="o">=</span> <span class="nx">NSMutableAttributedString</span><span class="p">(</span><span class="nx">string</span><span class="p">:</span> <span class="dl">"</span><span class="s2"> </span><span class="se">\</span><span class="s2">(model.string)</span><span class="dl">"</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">:</span> <span class="p">[</span><span class="nx">NSAttributedString</span><span class="p">.</span><span class="nx">Key</span><span class="p">.</span><span class="nx">foregroundColor</span><span class="p">:</span><span class="nx">UIColor</span><span class="p">(</span><span class="nx">hexString</span><span class="p">:</span> <span class="dl">"</span><span class="s2">#497BF2</span><span class="dl">"</span><span class="p">),</span><span class="nx">NSAttributedString</span><span class="p">.</span><span class="nx">Key</span><span class="p">.</span><span class="nx">font</span><span class="p">:</span> <span class="nx">QMFontFit</span><span class="p">(</span><span class="nx">size</span><span class="p">:</span> <span class="mi">14</span><span class="p">),</span><span class="nx">NSAttributedString</span><span class="p">.</span><span class="nx">Key</span><span class="p">.</span><span class="nx">link</span><span class="p">:</span> <span class="dl">"</span><span class="s2"> </span><span class="se">\</span><span class="s2">(model.string) </span><span class="dl">"</span><span class="p">.</span><span class="nx">addingPercentEncoding</span><span class="p">(</span><span class="nx">withAllowedCharacters</span><span class="p">:</span> <span class="p">.</span><span class="nx">urlFragmentAllowed</span><span class="p">)</span><span class="o">!</span><span class="p">])</span>
        <span class="kd">let</span> <span class="nx">spaceString</span><span class="p">:</span> <span class="nx">NSMutableAttributedString</span> <span class="o">=</span> <span class="nx">NSMutableAttributedString</span><span class="p">(</span><span class="nx">string</span><span class="p">:</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">:</span> <span class="p">[</span><span class="nx">NSAttributedString</span><span class="p">.</span><span class="nx">Key</span><span class="p">.</span><span class="nx">foregroundColor</span><span class="p">:</span><span class="nx">UIColor</span><span class="p">(</span><span class="nx">hexString</span><span class="p">:</span> <span class="dl">"</span><span class="s2">#666666</span><span class="dl">"</span><span class="p">),</span><span class="nx">NSAttributedString</span><span class="p">.</span><span class="nx">Key</span><span class="p">.</span><span class="nx">font</span><span class="p">:</span> <span class="nx">QMFontFit</span><span class="p">(</span><span class="nx">size</span><span class="p">:</span> <span class="mi">14</span><span class="p">)])</span>
        <span class="nx">richTextView</span><span class="p">.</span><span class="nx">textStorage</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">tagString</span><span class="p">,</span> <span class="nx">at</span><span class="p">:</span> <span class="nx">richTextView</span><span class="p">.</span><span class="nx">selectedRange</span><span class="p">.</span><span class="nx">location</span><span class="p">)</span>
        <span class="nx">richTextView</span><span class="p">.</span><span class="nx">textStorage</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">spaceString</span><span class="p">,</span> <span class="nx">at</span><span class="p">:</span> <span class="nx">richTextView</span><span class="p">.</span><span class="nx">selectedRange</span><span class="p">.</span><span class="nx">location</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> </span><span class="se">\</span><span class="s2">(model.string)</span><span class="dl">"</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nx">richTextView</span><span class="p">.</span><span class="nx">textStorage</span><span class="p">.</span><span class="nx">addAttributes</span><span class="p">([</span><span class="nx">NSAttributedString</span><span class="p">.</span><span class="nx">Key</span><span class="p">.</span><span class="nx">paragraphStyle</span> <span class="p">:</span> <span class="nx">style</span><span class="p">],</span> <span class="nx">range</span><span class="p">:</span> <span class="nx">NSRange</span><span class="p">(</span><span class="nx">location</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span><span class="p">:</span> <span class="nx">richTextView</span><span class="p">.</span><span class="nx">textStorage</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span>
        
        <span class="nx">richTextView</span><span class="p">.</span><span class="nx">selectedRange</span> <span class="o">=</span> <span class="nx">NSRange</span><span class="p">(</span><span class="nx">location</span><span class="p">:</span> <span class="nx">fullModel</span><span class="p">.</span><span class="nx">location</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> </span><span class="se">\</span><span class="s2">(model.string) </span><span class="dl">"</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">length</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="kd">let</span> <span class="nx">callBack</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nx">changeFrameBlock</span><span class="p">{</span>
            <span class="nx">callBack</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>ä¸Šé¢çš„æ³¨é‡Šåº”è¯¥å†™æ¸…æ¥šäº†ä¸»è¦çš„æ€è·¯ã€‚
æ’å…¥å›¾ç‰‡çš„æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1">//ä¸è®©å›¾ç‰‡å˜å½¢</span>
        <span class="kd">let</span> <span class="nx">size</span> <span class="o">=</span> <span class="nx">getImageSize</span><span class="p">(</span><span class="nx">image</span><span class="p">:</span> <span class="nx">image</span><span class="p">)</span>
        <span class="kd">let</span> <span class="nx">imgHeight</span> <span class="o">=</span> <span class="p">(</span><span class="nx">kScreenWidth</span> <span class="o">-</span> <span class="mi">40</span><span class="p">)</span> <span class="o">*</span> <span class="nx">size</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="nx">size</span><span class="p">.</span><span class="nx">width</span>
        <span class="kd">let</span> <span class="nx">imgWidth</span> <span class="o">=</span> <span class="nx">kScreenWidth</span> <span class="o">-</span> <span class="mi">40</span>
        
        <span class="kd">let</span> <span class="nx">attachment</span> <span class="o">=</span> <span class="nx">NSTextAttachment</span><span class="p">()</span>
        <span class="nx">attachment</span><span class="p">.</span><span class="nx">image</span> <span class="o">=</span> <span class="nx">image</span>
        <span class="nx">attachment</span><span class="p">.</span><span class="nx">bounds</span> <span class="o">=</span> <span class="nx">CGRect</span><span class="p">(</span><span class="nx">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">width</span><span class="p">:</span> <span class="nx">imgWidth</span><span class="p">,</span> <span class="nx">height</span><span class="p">:</span> <span class="nx">imgHeight</span><span class="p">)</span>
        <span class="kd">let</span> <span class="nx">attStr</span> <span class="o">=</span> <span class="nx">NSAttributedString</span><span class="p">(</span><span class="nx">attachment</span><span class="p">:</span> <span class="nx">attachment</span><span class="p">)</span>
        
        <span class="kd">let</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">NSMutableParagraphStyle</span><span class="p">()</span>
        <span class="nx">style</span><span class="p">.</span><span class="nx">lineBreakMode</span> <span class="o">=</span> <span class="p">.</span><span class="nx">byCharWrapping</span>
        <span class="kd">let</span> <span class="nx">spaceString</span><span class="p">:</span> <span class="nx">NSMutableAttributedString</span> <span class="o">=</span> <span class="nx">NSMutableAttributedString</span><span class="p">(</span><span class="nx">string</span><span class="p">:</span> <span class="dl">"</span><span class="se">\n</span><span class="dl">"</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">:</span> <span class="p">[</span><span class="nx">NSAttributedString</span><span class="p">.</span><span class="nx">Key</span><span class="p">.</span><span class="nx">foregroundColor</span><span class="p">:</span><span class="nx">UIColor</span><span class="p">(</span><span class="nx">hexString</span><span class="p">:</span> <span class="dl">"</span><span class="s2">#666666</span><span class="dl">"</span><span class="p">),</span><span class="nx">NSAttributedString</span><span class="p">.</span><span class="nx">Key</span><span class="p">.</span><span class="nx">font</span><span class="p">:</span> <span class="nx">QMFontFit</span><span class="p">(</span><span class="nx">size</span><span class="p">:</span> <span class="mi">14</span><span class="p">)])</span>
        <span class="nx">richTextView</span><span class="p">.</span><span class="nx">textStorage</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">attStr</span><span class="p">,</span> <span class="nx">at</span><span class="p">:</span> <span class="nx">richTextView</span><span class="p">.</span><span class="nx">selectedRange</span><span class="p">.</span><span class="nx">location</span><span class="p">)</span>
        <span class="nx">richTextView</span><span class="p">.</span><span class="nx">textStorage</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">spaceString</span><span class="p">,</span> <span class="nx">at</span><span class="p">:</span> <span class="nx">richTextView</span><span class="p">.</span><span class="nx">selectedRange</span><span class="p">.</span><span class="nx">location</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nx">richTextView</span><span class="p">.</span><span class="nx">textStorage</span><span class="p">.</span><span class="nx">addAttributes</span><span class="p">([</span><span class="nx">NSAttributedString</span><span class="p">.</span><span class="nx">Key</span><span class="p">.</span><span class="nx">paragraphStyle</span> <span class="p">:</span> <span class="nx">style</span><span class="p">],</span> <span class="nx">range</span><span class="p">:</span> <span class="nx">NSRange</span><span class="p">(</span><span class="nx">location</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span><span class="p">:</span> <span class="nx">richTextView</span><span class="p">.</span><span class="nx">textStorage</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span>
</code></pre></div></div>
<p>è‡³æ­¤æ’å…¥æ ‡ç­¾æ‰€æœ‰æ–¹æ³•å®Œæˆã€‚</p>

<h3 id="ç¬¬å››æ­¥-å¤„ç†å¢åŠ åˆ é™¤">ç¬¬å››æ­¥: å¤„ç†å¢åŠ åˆ é™¤</h3>
<p>ç°åœ¨é—®é¢˜æ¥äº†ï¼Œåœ¨å†…å®¹ä¸­é—´æ’å…¥æ–‡å­—åŠåˆ é™¤æ–‡å­—å’Œåˆ é™¤æ ‡ç­¾è¿˜æ²¡å¤„ç†ï¼Œä¸€æ—¦æ’å…¥æ–‡å­—æˆ‘ä»¬æ‰€æœ‰å­˜å‚¨çš„çš„æ–‡å­—éœ€è¦å¯¹åº”è°ƒæ•´locationï¼Œè§æœ€ä¸Šé¢çš„ä»£ç ã€‚
æ‰€ä»¥ä¿®æ”¹TextViewä»£ç†æ–¹æ³• shouldChangeTextIn, åœ¨é‡Œé¢åšlocationçš„éå†ä¿®æ”¹å¤„ç†ã€‚
ç¼–è¯‘è¿è¡Œä¸€ä¸‹ä»£ç ï¼Œå‘ç°äº†ä¸€ä¸ªé‡è¦çš„é—®é¢˜ï¼Œemojiçš„å ä½ç¬¦å’Œæ™®é€šæ–‡å­—ä¸åŒï¼Œä¼šå¯¼è‡´æ ‡ç­¾é”™ä¹±é—ªé€€ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿ
æä¸å®šäº†å»æŸ¥stackoverflowï¼Œäº†è§£åˆ°utf16.countã€‚æƒ³äº†ä¸€ä¸‹å¯ä»¥é€šè¿‡è¿™ä¸ªç¬¨æ–¹æ³•æ‹¿åˆ°å…·ä½“çš„ç¡®å®šå ä½ç¬¦ï¼Œæ–¹æ³•å¦‚ä¸‹:</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nx">func</span> <span class="nx">setEmojiStringLength</span><span class="p">(</span><span class="nx">text</span><span class="p">:</span> <span class="nb">String</span> <span class="o">=</span> <span class="dl">""</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Int</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="nx">char</span> <span class="k">in</span> <span class="nx">text</span> <span class="o">==</span> <span class="dl">""</span> <span class="p">?</span> <span class="nx">richTextView</span><span class="p">.</span><span class="nx">text</span> <span class="p">:</span> <span class="nx">text</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">contentRange</span><span class="p">.</span><span class="nx">location</span> <span class="o">&gt;</span> <span class="nx">i</span> <span class="p">{</span>
                <span class="nx">i</span> <span class="o">+=</span> <span class="nx">char</span><span class="p">.</span><span class="nx">utf16</span><span class="p">.</span><span class="nx">count</span>
                <span class="nx">length</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">length</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>åˆ°ç°åœ¨ä¸ºæ­¢åŸºæœ¬ä¸Šéœ€æ±‚éƒ½æ»¡è¶³äº†ï¼Œåˆç‰¹ä¹ˆå‘ç°äº†ä¸€ä¸ªé—®é¢˜â€¦. åˆ é™¤æ ‡ç­¾è¦æ•´ä½“åˆ é™¤ï¼ä»¥åŠæ‹–åŠ¨å…‰æ ‡ä¸èƒ½åœ¨æ ‡ç­¾å†…æ’å…¥æ–‡å­—ã€‚è¿™ä¸ªéœ€æ±‚æ¼æ‰äº†ã€‚</p>

<h3 id="ç¬¬äº”æ­¥-å¤„ç†æ ‡ç­¾åŒºåŸŸåˆ é™¤ç­‰ç»†èŠ‚">ç¬¬äº”æ­¥: å¤„ç†æ ‡ç­¾åŒºåŸŸåˆ é™¤ç­‰ç»†èŠ‚</h3>
<p>å…³é”®ä»£ç æ¥äº†ï¼š</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="nx">richTextView</span><span class="p">.</span><span class="nx">markedTextRange</span> <span class="o">==</span> <span class="nx">nil</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">modelArray</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">textView</span><span class="p">.</span><span class="nx">selectedRange</span><span class="p">.</span><span class="nx">location</span> <span class="o">&lt;=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">location</span> <span class="o">+</span> <span class="nx">item</span><span class="p">.</span><span class="nx">length</span>  <span class="o">&amp;&amp;</span> <span class="nx">textView</span><span class="p">.</span><span class="nx">selectedRange</span><span class="p">.</span><span class="nx">location</span> <span class="o">&gt;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">location</span> <span class="p">{</span>
            <span class="nx">textView</span><span class="p">.</span><span class="nx">selectedRange</span> <span class="o">=</span> <span class="nx">NSRange</span><span class="p">(</span><span class="nx">location</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">location</span> <span class="o">+</span> <span class="nx">item</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">length</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>ä¸€æ—¦é€‰ä¸­åŒºåŸŸåœ¨æ•°æ®é‡Œé¢åŒ…å«äº†ï¼Œç›´æ¥å®šä½æ•´ä½“åŒºåŸŸå—ã€‚</p>

<p>å…³äºåˆ é™¤åŒºåŸŸï¼Œä¸€æ–¹é¢è¦åˆ é™¤UIå±‚é¢æ˜¾ç¤ºçš„æ–‡å­—ï¼Œå¦ä¸€æ–¹é¢è¦åˆ é™¤å¯¹åº”åŒºåŸŸçš„æ•°æ®æºï¼Œå¹¶ä¸”åˆ é™¤å®Œæ¯•åç»§ç»­åŠ¨æ€ä¿®æ”¹åé¢æ•°æ®æºçš„locationã€‚</p>

<p>okå®ç°å®Œæ¯•ï¼Œè™½ç„¶æ„Ÿè§‰æœ‰äº›è®¸ç²—ç³™ï¼Œä½†æ˜¯éœ€æ±‚åŸºæœ¬æ»¡è¶³äº†ã€‚åé¢æœ‰æ—¶é—´å†æ‹¿CoreTextæä¸€éå§</p>

<h2 id="ç»“æŸ">ç»“æŸ</h2>

<p>æ¬¢è¿äº¤æµã€‚</p>

<p>â€”â€” Ade</p>

:ET